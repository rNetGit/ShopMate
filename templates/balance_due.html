{% extends "base.html" %}

{% block title %}Balance Due - Store Management{% endblock %}

{% block extra_head %}
<style>
    /* Burger menu animations */
    .burger-line {
        transition: all 0.3s ease;
        transform-origin: center;
    }

    .burger-active .burger-line:nth-child(1) {
        transform: rotate(45deg) translate(6px, 6px);
    }

    .burger-active .burger-line:nth-child(2) {
        opacity: 0;
    }

    .burger-active .burger-line:nth-child(3) {
        transform: rotate(-45deg) translate(6px, -6px);
    }

    /* Mobile menu overlay */
    .menu-overlay {
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
    }

    body {
        min-height: max(884px, 100dvh);
    }

    .stats-card {
        transition: all 0.3s ease;
    }

        .stats-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

    .balance-card {
        transition: all 0.2s ease;
    }

        .balance-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

    .payment-row {
        transition: background-color 0.2s ease;
    }

        .payment-row:hover {
            background-color: rgba(17, 115, 212, 0.05);
        }

    .due-indicator {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="flex h-screen flex-col overflow-hidden">
    <!-- Enhanced Mobile-First Header -->
    <header class="flex-shrink-0 bg-white/95 dark:bg-surface-dark/95 backdrop-blur-sm border-b border-border dark:border-border-dark sticky top-0 z-50">
        <div class="flex h-16 items-center justify-between px-4 sm:px-6">
            <!-- Left: Burger Menu -->
            <button id="menu-toggle"
                    class="flex flex-col w-8 h-8 justify-center items-center space-y-1.5 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg p-1 transition-colors"
                    onclick="toggleMenu()">
                <div class="burger-line w-6 h-0.5 bg-gray-600 dark:bg-gray-300 rounded-full"></div>
                <div class="burger-line w-6 h-0.5 bg-gray-600 dark:bg-gray-300 rounded-full"></div>
                <div class="burger-line w-6 h-0.5 bg-gray-600 dark:bg-gray-300 rounded-full"></div>
            </button>

            <!-- Center: Logo & Title -->
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-red-500 rounded-xl flex items-center justify-center">
                    <span class="material-symbols-rounded text-white text-lg">account_balance_wallet</span>
                </div>
                <h1 class="text-lg font-bold hidden sm:block">Balance Due</h1>
            </div>

            <!-- Right: Actions -->
            <div class="flex items-center gap-2">
                <!-- Theme Toggle -->
                <button class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl transition-colors"
                        onclick="toggleDarkMode()">
                    <span class="material-symbols-rounded text-gray-600 dark:text-gray-300" id="theme-toggle">dark_mode</span>
                </button>

                <!-- Refresh -->
                <button class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl transition-colors"
                        onclick="refreshData()">
                    <span class="material-symbols-rounded text-gray-600 dark:text-gray-300">refresh</span>
                </button>

                <!-- Profile -->
                <div class="w-8 h-8 bg-gradient-to-br from-primary to-primary-light rounded-xl flex items-center justify-center">
                    <span class="material-symbols-rounded text-white text-sm">person</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Burger Menu Sidebar -->
    <div id="menu-overlay" class="fixed inset-0 bg-black/50 menu-overlay z-40 hidden" onclick="closeMenu()"></div>
    <div id="menu-sidebar" class="fixed top-0 right-0 h-full w-80 max-w-[85vw] bg-white dark:bg-surface-dark border-l border-border dark:border-border-dark z-50 transform translate-x-full transition-transform duration-300">
        <!-- Menu Header -->
        <div class="p-6 border-b border-border dark:border-border-dark">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">Menu</h2>
                <button onclick="closeMenu()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl transition-colors">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <div class="flex items-center gap-3 p-3 bg-surface dark:bg-background-dark rounded-xl">
                <div class="w-10 h-10 bg-gradient-to-br from-primary to-primary-light rounded-xl flex items-center justify-center">
                    <span class="material-symbols-rounded text-white">person</span>
                </div>
                <div>
                    <p class="font-semibold">Admin User</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">admin@store.com</p>
                </div>
            </div>
        </div>

        <!-- Menu Items -->
        <!-- Menu Items -->
        <nav class="p-6 space-y-2">
            <a href="{{ url_for('dashboard') }}" class="flex items-center gap-4 p-4 rounded-xl bg-primary/10 text-primary font-medium">
                <span class="material-symbols-rounded">dashboard</span>
                <span>Dashboard</span>
            </a>
            <a href="{{ url_for('orders') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-rounded">receipt_long</span>
                <span>Orders</span>
                <span class="ml-auto bg-red-500 text-white text-xs px-2 py-1 rounded-full">{{ data.active_orders }}</span>
            </a>
            <a href="{{ url_for('create_order') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-rounded">add_circle</span>
                <span>Create Order</span>
            </a>
            <a href="{{ url_for('customers') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-rounded">group</span>
                <span>Customers</span>
            </a>
            <a href="{{ url_for('items') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-rounded">inventory</span>
                <span>Item Master</span>
            </a>
            <!-- ADD THESE TWO MISSING MENU ITEMS -->
            <a href="{{ url_for('drivers') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-rounded">drive_eta</span>
                <span>Drivers</span>
            </a>
            <a href="{{ url_for('expenses') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-rounded">receipt</span>
                <span>Expenses</span>
            </a>
            <!-- END OF ADDED ITEMS -->
            <a href="{{ url_for('delivery_charges') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-rounded">local_shipping</span>
                <span>Delivery Charges</span>
            </a>
            <a href="{{ url_for('balance_due') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-rounded">account_balance_wallet</span>
                <span>Balance Due</span>
            </a>

            <div class="border-t border-border dark:border-border-dark my-4"></div>

            <a href="{{ url_for('settings') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-rounded">settings</span>
                <span>Settings</span>
            </a>
            <a href="{{ url_for('help_support') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-rounded">help</span>
                <span>Help & Support</span>
            </a>
            <a href="{{ url_for('logout') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 dark:text-red-400 transition-colors">
                <span class="material-symbols-rounded">logout</span>
                <span>Logout</span>
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto">
        <div class="p-4 space-y-6">
            <!-- Summary Stats -->
            <section>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="stats-card bg-white dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border dark:border-border-dark">
                        <div class="flex items-center gap-3">
                            <div class="bg-red-100 dark:bg-red-900/30 p-3 rounded-full">
                                <span class="material-symbols-rounded text-red-600 dark:text-red-400">account_balance</span>
                            </div>
                            <div>
                                <p class="text-2xl font-bold" id="total-due">$8,450</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Total Due</p>
                            </div>
                        </div>
                    </div>

                    <div class="stats-card bg-white dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border dark:border-border-dark">
                        <div class="flex items-center gap-3">
                            <div class="bg-green-100 dark:bg-green-900/30 p-3 rounded-full">
                                <span class="material-symbols-rounded text-green-600 dark:text-green-400">payments</span>
                            </div>
                            <div>
                                <p class="text-2xl font-bold" id="total-collected">$12,350</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Total Collected</p>
                            </div>
                        </div>
                    </div>

                    <div class="stats-card bg-white dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border dark:border-border-dark">
                        <div class="flex items-center gap-3">
                            <div class="bg-orange-100 dark:bg-orange-900/30 p-3 rounded-full">
                                <span class="material-symbols-rounded text-orange-600 dark:text-orange-400">person</span>
                            </div>
                            <div>
                                <p class="text-2xl font-bold" id="customers-with-due">8</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Customers with Due</p>
                            </div>
                        </div>
                    </div>

                    <div class="stats-card bg-white dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border dark:border-border-dark">
                        <div class="flex items-center gap-3">
                            <div class="bg-blue-100 dark:bg-blue-900/30 p-3 rounded-full">
                                <span class="material-symbols-rounded text-blue-600 dark:text-blue-400">calendar_today</span>
                            </div>
                            <div>
                                <p class="text-2xl font-bold" id="overdue-count">3</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Overdue</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Quick Actions -->
            <section>
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">Quick Actions</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="showAddDueModal()" class="balance-card flex items-center gap-4 bg-red-500 text-white p-4 rounded-xl hover:bg-red-600 transition-all">
                        <span class="material-symbols-rounded text-2xl">add_circle</span>
                        <div class="text-left">
                            <p class="font-semibold text-lg">Add New Due</p>
                            <p class="text-sm text-white/80">Create new balance due record</p>
                        </div>
                    </button>
                    <button onclick="showReceivePaymentModal()" class="balance-card flex items-center gap-4 bg-white dark:bg-surface-dark border border-border dark:border-border-dark p-4 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 transition-all">
                        <span class="material-symbols-rounded text-2xl text-green-600">payments</span>
                        <div class="text-left">
                            <p class="font-semibold text-lg">Receive Payment</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Record customer payment</p>
                        </div>
                    </button>
                </div>
            </section>

            <!-- Customer Balance List -->
            <section>
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">Customer Balances</h2>
                    <div class="flex gap-2">
                        <select class="px-3 py-1.5 text-sm bg-white dark:bg-surface-dark border border-border dark:border-border-dark rounded-lg" onchange="filterCustomers(this.value)">
                            <option value="">All Customers</option>
                            <option value="overdue">Overdue Only</option>
                            <option value="high">High Balance ($1000+)</option>
                        </select>
                    </div>
                </div>
                <div class="space-y-3" id="customer-balances">
                    <!-- Customer balances will be populated here -->
                </div>
            </section>

            <!-- Recent Transactions -->
            <section>
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">Recent Transactions</h2>
                    <button class="text-primary text-sm hover:underline" onclick="viewAllTransactions()">View All</button>
                </div>
                <div class="bg-white dark:bg-surface-dark border border-border dark:border-border-dark rounded-xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 dark:bg-gray-800">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Customer</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Type</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Amount</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Description</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-border dark:divide-border-dark" id="transaction-history">
                                <!-- Transaction history will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </main>
</div>

<!-- Add New Due Modal -->
<div id="add-due-modal" class="fixed inset-0 bg-black/50 z-50 hidden" onclick="closeModal('add-due-modal')">
    <div class="absolute inset-x-4 top-1/2 transform -translate-y-1/2 max-w-md mx-auto bg-white dark:bg-surface-dark rounded-xl shadow-xl" onclick="event.stopPropagation()">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Add New Due</h3>
                <button onclick="closeModal('add-due-modal')" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <form onsubmit="addNewDue(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Select Customer</label>
                    <select name="customerId" required class="w-full px-3 py-2 border border-border dark:border-border-dark rounded-lg bg-white dark:bg-surface-dark">
                        <option value="">Choose customer...</option>
                        <option value="1">John Doe - 123 Main St</option>
                        <option value="2">Jane Smith - 456 Oak Ave</option>
                        <option value="3">Bob Johnson - 789 Pine Ln</option>
                        <option value="4">Alice Brown - 321 Elm St</option>
                        <option value="5">Charlie Davis - 654 Maple Dr</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Date</label>
                    <input type="date" name="dueDate" required class="w-full px-3 py-2 border border-border dark:border-border-dark rounded-lg bg-white dark:bg-surface-dark">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Amount Due ($)</label>
                    <input type="number" name="amountDue" step="0.01" placeholder="0.00" required class="w-full px-3 py-2 border border-border dark:border-border-dark rounded-lg bg-white dark:bg-surface-dark">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Description</label>
                    <textarea name="description" rows="3" placeholder="Reason for balance due..." required class="w-full px-3 py-2 border border-border dark:border-border-dark rounded-lg bg-white dark:bg-surface-dark"></textarea>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeModal('add-due-modal')" class="flex-1 px-4 py-2 border border-border dark:border-border-dark rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                        Add Due
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Receive Payment Modal -->
<div id="receive-payment-modal" class="fixed inset-0 bg-black/50 z-50 hidden" onclick="closeModal('receive-payment-modal')">
    <div class="absolute inset-x-4 top-1/2 transform -translate-y-1/2 max-w-md mx-auto bg-white dark:bg-surface-dark rounded-xl shadow-xl" onclick="event.stopPropagation()">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Receive Payment</h3>
                <button onclick="closeModal('receive-payment-modal')" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <form onsubmit="receivePayment(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Select Customer</label>
                    <select name="customerId" required class="w-full px-3 py-2 border border-border dark:border-border-dark rounded-lg bg-white dark:bg-surface-dark" id="payment-customer-select">
                        <option value="">Choose customer with due balance...</option>
                    </select>
                </div>
                <div id="customer-balance-details" class="hidden bg-gray-50 dark:bg-gray-800 p-3 rounded-lg">
                    <p class="text-sm"><span class="font-medium">Customer:</span> <span id="selected-customer-name"></span></p>
                    <p class="text-sm"><span class="font-medium">Total Balance Due:</span> $<span id="selected-customer-balance"></span></p>
                    <p class="text-sm"><span class="font-medium">Oldest Due Date:</span> <span id="selected-customer-oldest"></span></p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Payment Date</label>
                    <input type="date" name="paymentDate" required class="w-full px-3 py-2 border border-border dark:border-border-dark rounded-lg bg-white dark:bg-surface-dark">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Payment Amount ($)</label>
                    <input type="number" name="paymentAmount" step="0.01" placeholder="0.00" required class="w-full px-3 py-2 border border-border dark:border-border-dark rounded-lg bg-white dark:bg-surface-dark" oninput="validatePaymentAmount(this)">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Enter partial or full payment amount</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Payment Method</label>
                    <select name="paymentMethod" required class="w-full px-3 py-2 border border-border dark:border-border-dark rounded-lg bg-white dark:bg-surface-dark">
                        <option value="">Select payment method</option>
                        <option value="Cash">Cash</option>
                        <option value="Card">Card</option>
                        <option value="Check">Check</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="Online">Online Payment</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Notes (Optional)</label>
                    <textarea name="notes" rows="2" placeholder="Payment notes..." class="w-full px-3 py-2 border border-border dark:border-border-dark rounded-lg bg-white dark:bg-surface-dark"></textarea>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeModal('receive-payment-modal')" class="flex-1 px-4 py-2 border border-border dark:border-border-dark rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Receive Payment
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Menu Functions
    function toggleMenu() {
        const menuToggle = document.getElementById('menu-toggle');
        const menuOverlay = document.getElementById('menu-overlay');
        const menuSidebar = document.getElementById('menu-sidebar');

        menuToggle.classList.toggle('burger-active');
        menuOverlay.classList.toggle('hidden');

        if (menuSidebar.style.transform === 'translateX(0px)') {
            menuSidebar.style.transform = 'translateX(100%)';
        } else {
            menuSidebar.style.transform = 'translateX(0px)';
        }
    }

    function closeMenu() {
        const menuToggle = document.getElementById('menu-toggle');
        const menuOverlay = document.getElementById('menu-overlay');
        const menuSidebar = document.getElementById('menu-sidebar');

        menuToggle.classList.remove('burger-active');
        menuOverlay.classList.add('hidden');
        menuSidebar.style.transform = 'translateX(100%)';
    }

    // Sample data
    let customerBalances = [
        {
            id: 1,
            name: "John Doe",
            address: "123 Main St",
            totalDue: 1250.00,
            oldestDueDate: "2024-11-15",
            dueEntries: [
                { date: "2024-11-15", amount: 750.00, description: "Order #12345 - Rings and Accessories", remaining: 750.00 },
                { date: "2024-12-01", amount: 500.00, description: "Order #12367 - Custom Items", remaining: 500.00 }
            ]
        },
        {
            id: 2,
            name: "Jane Smith",
            address: "456 Oak Ave",
            totalDue: 890.00,
            oldestDueDate: "2024-11-20",
            dueEntries: [
                { date: "2024-11-20", amount: 890.00, description: "Order #12356 - Bulk Purchase", remaining: 890.00 }
            ]
        },
        {
            id: 3,
            name: "Bob Johnson",
            address: "789 Pine Ln",
            totalDue: 2150.00,
            oldestDueDate: "2024-10-28",
            dueEntries: [
                { date: "2024-10-28", amount: 1200.00, description: "Order #12340 - Large Order", remaining: 1200.00 },
                { date: "2024-11-25", amount: 950.00, description: "Order #12378 - Special Items", remaining: 950.00 }
            ]
        },
        {
            id: 4,
            name: "Alice Brown",
            address: "321 Elm St",
            totalDue: 675.00,
            oldestDueDate: "2024-12-02",
            dueEntries: [
                { date: "2024-12-02", amount: 675.00, description: "Order #12380 - Regular Purchase", remaining: 675.00 }
            ]
        },
        {
            id: 5,
            name: "Charlie Davis",
            address: "654 Maple Dr",
            totalDue: 1480.00,
            oldestDueDate: "2024-11-10",
            dueEntries: [
                { date: "2024-11-10", amount: 800.00, description: "Order #12335 - Monthly Order", remaining: 800.00 },
                { date: "2024-11-28", amount: 680.00, description: "Order #12375 - Additional Items", remaining: 680.00 }
            ]
        },
        {
            id: 6,
            name: "Diana Wilson",
            address: "987 Cedar Ave",
            totalDue: 0.00,
            oldestDueDate: null,
            dueEntries: []
        }
    ];

    let transactionHistory = [
        {
            date: '2024-12-10',
            customerId: 1,
            customerName: 'John Doe',
            type: 'Payment',
            amount: -300.00,
            description: 'Partial payment - Cash'
        },
        {
            date: '2024-12-09',
            customerId: 4,
            customerName: 'Alice Brown',
            type: 'Due Added',
            amount: 675.00,
            description: 'Order #12380 - Regular Purchase'
        },
        {
            date: '2024-12-08',
            customerId: 2,
            customerName: 'Jane Smith',
            type: 'Payment',
            amount: -250.00,
            description: 'Partial payment - Card'
        },
        {
            date: '2024-12-07',
            customerId: 3,
            customerName: 'Bob Johnson',
            type: 'Due Added',
            amount: 950.00,
            description: 'Order #12378 - Special Items'
        }
    ];

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadCustomerBalances();
        loadTransactionHistory();
        updateStats();

        // Set today's date as default in forms
        const today = new Date().toISOString().split('T')[0];
        document.querySelectorAll('input[type="date"]').forEach(input => {
            if (!input.value) input.value = today;
        });

        // Check for saved dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            document.documentElement.classList.add('dark');
            document.getElementById('theme-toggle').textContent = 'light_mode';
        }

        // Close menu on window resize
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                closeMenu();
            }
        });
    });

    function loadCustomerBalances() {
        const container = document.getElementById('customer-balances');
        container.innerHTML = '';

        const customersWithBalance = customerBalances.filter(customer => customer.totalDue > 0);

        if (customersWithBalance.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                    <span class="material-symbols-rounded text-6xl mb-4 block">account_balance_wallet</span>
                    <p>No outstanding balances</p>
                    <p class="text-sm">All customers have cleared their dues</p>
                </div>
            `;
            return;
        }

        customersWithBalance.forEach(customer => {
            const isOverdue = customer.oldestDueDate && new Date(customer.oldestDueDate) < new Date();
            const daysPastDue = isOverdue ? Math.floor((new Date() - new Date(customer.oldestDueDate)) / (1000 * 60 * 60 * 24)) : 0;

            const balanceCard = document.createElement('div');
            balanceCard.className = 'balance-card bg-white dark:bg-surface-dark border border-border dark:border-border-dark rounded-xl p-4 shadow-sm';
            balanceCard.innerHTML = `
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <div class="due-indicator w-3 h-3 ${isOverdue ? 'bg-red-500' : 'bg-orange-500'} rounded-full"></div>
                        <div>
                            <p class="font-semibold">${customer.name}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${customer.address}</p>
                        </div>
                    </div>
                    <span class="px-2 py-1 ${isOverdue ? 'bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400' : 'bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400'} text-xs font-medium rounded-full">
                        ${isOverdue ? `${daysPastDue} days overdue` : 'Due'}
                    </span>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Total Balance</p>
                        <p class="text-lg font-bold ${isOverdue ? 'text-red-600 dark:text-red-400' : 'text-orange-600 dark:text-orange-400'}">$${customer.totalDue.toLocaleString('en-US', {minimumFractionDigits: 2})}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Oldest Due Date</p>
                        <p class="text-sm font-medium">${new Date(customer.oldestDueDate).toLocaleDateString()}</p>
                    </div>
                </div>

                <div class="mb-3">
                    <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">Recent Entries</p>
                    <div class="space-y-1">
                        ${customer.dueEntries.slice(0, 2).map(entry => `
                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                ${new Date(entry.date).toLocaleDateString()} - $${entry.remaining.toFixed(2)} - ${entry.description.substring(0, 30)}...
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="flex gap-2">
                    <button onclick="showReceivePaymentModalForCustomer(${customer.id})" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        <span class="material-symbols-rounded text-sm mr-1">payments</span>
                        Receive Payment
                    </button>
                    <button onclick="viewCustomerDetails(${customer.id})" class="px-4 py-2 border border-border dark:border-border-dark rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                        <span class="material-symbols-rounded text-sm">visibility</span>
                    </button>
                </div>
            `;
            container.appendChild(balanceCard);
        });

        // Update payment customer select dropdown
        updatePaymentCustomerSelect();
    }

    function loadTransactionHistory() {
        const tbody = document.getElementById('transaction-history');
        tbody.innerHTML = '';

        transactionHistory.slice(0, 10).forEach(transaction => {
            const row = document.createElement('tr');
            row.className = 'payment-row';
            const isPayment = transaction.type === 'Payment';
            row.innerHTML = `
                <td class="px-4 py-3 text-sm">${new Date(transaction.date).toLocaleDateString()}</td>
                <td class="px-4 py-3 text-sm">${transaction.customerName}</td>
                <td class="px-4 py-3 text-sm">
                    <span class="px-2 py-1 text-xs rounded-full ${isPayment ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${transaction.type}
                    </span>
                </td>
                <td class="px-4 py-3 text-sm font-medium ${isPayment ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                    ${isPayment ? '' : '+'}$${Math.abs(transaction.amount).toLocaleString('en-US', {minimumFractionDigits: 2})}
                </td>
                <td class="px-4 py-3 text-sm">${transaction.description}</td>
            `;
            tbody.appendChild(row);
        });
    }

    function updateStats() {
        const totalDue = customerBalances.reduce((sum, customer) => sum + customer.totalDue, 0);
        const totalCollected = Math.abs(transactionHistory.filter(t => t.type === 'Payment').reduce((sum, t) => sum + t.amount, 0));
        const customersWithDue = customerBalances.filter(customer => customer.totalDue > 0).length;
        const overdueCount = customerBalances.filter(customer =>
            customer.oldestDueDate && new Date(customer.oldestDueDate) < new Date()
        ).length;

        document.getElementById('total-due').textContent = `$${totalDue.toLocaleString('en-US')}`;
        document.getElementById('total-collected').textContent = `$${totalCollected.toLocaleString('en-US')}`;
        document.getElementById('customers-with-due').textContent = customersWithDue;
        document.getElementById('overdue-count').textContent = overdueCount;
    }

    function updatePaymentCustomerSelect() {
        const select = document.getElementById('payment-customer-select');
        select.innerHTML = '<option value="">Choose customer with due balance...</option>';

        customerBalances.filter(customer => customer.totalDue > 0).forEach(customer => {
            const option = document.createElement('option');
            option.value = customer.id;
            option.textContent = `${customer.name} - $${customer.totalDue.toLocaleString('en-US')} due`;
            select.appendChild(option);
        });

        select.addEventListener('change', function() {
            const customerId = parseInt(this.value);
            const customer = customerBalances.find(c => c.id === customerId);

            if (customer) {
                document.getElementById('selected-customer-name').textContent = customer.name;
                document.getElementById('selected-customer-balance').textContent = customer.totalDue.toLocaleString('en-US', {minimumFractionDigits: 2});
                document.getElementById('selected-customer-oldest').textContent = new Date(customer.oldestDueDate).toLocaleDateString();
                document.getElementById('customer-balance-details').classList.remove('hidden');
            } else {
                document.getElementById('customer-balance-details').classList.add('hidden');
            }
        });
    }

    function showAddDueModal() {
        document.getElementById('add-due-modal').classList.remove('hidden');
    }

    function showReceivePaymentModal() {
        updatePaymentCustomerSelect();
        document.getElementById('receive-payment-modal').classList.remove('hidden');
    }

    function showReceivePaymentModalForCustomer(customerId) {
        showReceivePaymentModal();
        setTimeout(() => {
            document.getElementById('payment-customer-select').value = customerId;
            document.getElementById('payment-customer-select').dispatchEvent(new Event('change'));
        }, 100);
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
    }

    function addNewDue(event) {
        event.preventDefault();
        const formData = new FormData(event.target);

        const customerId = parseInt(formData.get('customerId'));
        const customer = customerBalances.find(c => c.id === customerId);

        if (!customer) {
            alert('Please select a valid customer');
            return;
        }

        const newDue = {
            date: formData.get('dueDate'),
            amount: parseFloat(formData.get('amountDue')),
            description: formData.get('description'),
            remaining: parseFloat(formData.get('amountDue'))
        };

        // Update customer balance
        customer.dueEntries.push(newDue);
        customer.totalDue += newDue.amount;
        if (!customer.oldestDueDate || new Date(newDue.date) < new Date(customer.oldestDueDate)) {
            customer.oldestDueDate = newDue.date;
        }

        // Add to transaction history
        transactionHistory.unshift({
            date: newDue.date,
            customerId: customerId,
            customerName: customer.name,
            type: 'Due Added',
            amount: newDue.amount,
            description: newDue.description
        });

        loadCustomerBalances();
        loadTransactionHistory();
        updateStats();
        closeModal('add-due-modal');
        event.target.reset();

        showSuccessMessage(`New due of $${newDue.amount.toLocaleString('en-US')} added for ${customer.name}`);
    }

    function receivePayment(event) {
        event.preventDefault();
        const formData = new FormData(event.target);

        const customerId = parseInt(formData.get('customerId'));
        const paymentAmount = parseFloat(formData.get('paymentAmount'));

        const customer = customerBalances.find(c => c.id === customerId);
        if (!customer) {
            alert('Please select a valid customer');
            return;
        }

        if (paymentAmount > customer.totalDue) {
            alert(`Payment amount cannot exceed the balance due of $${customer.totalDue.toLocaleString('en-US')}`);
            return;
        }

        // Apply payment to oldest dues first
        let remainingPayment = paymentAmount;
        customer.dueEntries.sort((a, b) => new Date(a.date) - new Date(b.date));

        for (let entry of customer.dueEntries) {
            if (remainingPayment <= 0) break;

            const paymentToThisEntry = Math.min(remainingPayment, entry.remaining);
            entry.remaining -= paymentToThisEntry;
            remainingPayment -= paymentToThisEntry;
        }

        // Remove fully paid entries and update total due
        customer.dueEntries = customer.dueEntries.filter(entry => entry.remaining > 0);
        customer.totalDue -= paymentAmount;

        // Update oldest due date
        if (customer.dueEntries.length === 0) {
            customer.oldestDueDate = null;
        } else {
            customer.oldestDueDate = customer.dueEntries.sort((a, b) => new Date(a.date) - new Date(b.date))[0].date;
        }

        // Add to transaction history
        transactionHistory.unshift({
            date: formData.get('paymentDate'),
            customerId: customerId,
            customerName: customer.name,
            type: 'Payment',
            amount: -paymentAmount,
            description: `Payment - ${formData.get('paymentMethod')}${formData.get('notes') ? ' - ' + formData.get('notes') : ''}`
        });

        loadCustomerBalances();
        loadTransactionHistory();
        updateStats();
        closeModal('receive-payment-modal');
        event.target.reset();

        const isFullyPaid = customer.totalDue === 0;
        showSuccessMessage(
            `Payment of $${paymentAmount.toLocaleString('en-US')} received from ${customer.name}. ${
                isFullyPaid ? 'Account is now clear!' : `Remaining balance: $${customer.totalDue.toLocaleString('en-US')}`
            }`
        );
    }

    function validatePaymentAmount(input) {
        const customerId = parseInt(document.getElementById('payment-customer-select').value);
        const customer = customerBalances.find(c => c.id === customerId);

        if (customer && parseFloat(input.value) > customer.totalDue) {
            input.setCustomValidity(`Amount cannot exceed $${customer.totalDue.toLocaleString('en-US')}`);
        } else {
            input.setCustomValidity('');
        }
    }

    function filterCustomers(filter) {
        const balanceCards = document.querySelectorAll('#customer-balances .balance-card');

        balanceCards.forEach(card => {
            const customerName = card.querySelector('p.font-semibold').textContent;
            const customer = customerBalances.find(c => c.name === customerName);

            let shouldShow = true;

            if (filter === 'overdue') {
                shouldShow = customer.oldestDueDate && new Date(customer.oldestDueDate) < new Date();
            } else if (filter === 'high') {
                shouldShow = customer.totalDue >= 1000;
            }

            card.style.display = shouldShow ? 'block' : 'none';
        });
    }

    function viewCustomerDetails(customerId) {
        const customer = customerBalances.find(c => c.id === customerId);
        if (customer) {
            const duesList = customer.dueEntries.length > 0
                ? customer.dueEntries.map(d => `• ${d.date}: $${d.remaining.toLocaleString('en-US')} - ${d.description}`).join('\n')
                : 'No outstanding dues';

            alert(`Customer Details:\n\nName: ${customer.name}\nAddress: ${customer.address}\nTotal Due: $${customer.totalDue.toLocaleString('en-US')}\nOldest Due: ${customer.oldestDueDate ? new Date(customer.oldestDueDate).toLocaleDateString() : 'N/A'}\n\nDue Entries:\n${duesList}`);
        }
    }

    function viewAllTransactions() {
        alert('Opening full transaction history...');
    }

    function showSuccessMessage(message) {
        const successDiv = document.createElement('div');
        successDiv.className = 'fixed top-20 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
        successDiv.innerHTML = `
            <div class="flex items-center gap-2">
                <span class="material-symbols-rounded">check_circle</span>
                <span>${message}</span>
            </div>
        `;
        document.body.appendChild(successDiv);

        setTimeout(() => {
            successDiv.remove();
        }, 3000);
    }

    function refreshData() {
        loadCustomerBalances();
        loadTransactionHistory();
        updateStats();
        showSuccessMessage('Data refreshed successfully');
    }

    function toggleDarkMode() {
        document.documentElement.classList.toggle('dark');
        const toggle = document.getElementById('theme-toggle');
        toggle.textContent = document.documentElement.classList.contains('dark') ? 'light_mode' : 'dark_mode';
        localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
    }

    function goBack() {
        window.location.href = "{{ url_for('dashboard') }}";
    }
</script>
{% endblock %}