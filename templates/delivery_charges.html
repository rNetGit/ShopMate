<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Delivery Charges - Store Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#1173d4",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "content-light": "#1f2937",
                        "content-dark": "#e5e7eb",
                        "subtle-light": "#6b7280",
                        "subtle-dark": "#9ca3af",
                        "border-light": "#e5e7eb",
                        "border-dark": "#374151"
                    },
                    fontFamily: {
                        display: ["Manrope", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "0.25rem",
                        lg: "0.5rem",
                        xl: "0.75rem",
                        full: "9999px",
                    },
                },
            },
        };
    </script>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }

        /* Burger menu animations */
        .burger-line {
            transition: all 0.3s ease;
            transform-origin: center;
        }

        .burger-active .burger-line:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }

        .burger-active .burger-line:nth-child(2) {
            opacity: 0;
        }

        .burger-active .burger-line:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        /* Mobile menu overlay */
        .menu-overlay {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .stats-card {
            transition: all 0.3s ease;
        }

            .stats-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }

        .delivery-card {
            transition: all 0.2s ease;
        }

            .delivery-card:hover {
                transform: translateY(-1px);
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            }

        .payment-row {
            transition: background-color 0.2s ease;
        }

            .payment-row:hover {
                background-color: rgba(17, 115, 212, 0.05);
            }

        .pending-indicator {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-content-light dark:text-content-dark">
    <div class="flex h-screen flex-col overflow-hidden">
        <!-- Enhanced Mobile-First Header -->
        <header class="flex-shrink-0 bg-white/95 dark:bg-background-dark/95 backdrop-blur-sm border-b border-border-light dark:border-border-dark sticky top-0 z-50">
            <div class="flex h-16 items-center justify-between px-4 sm:px-6">
                <!-- Left: Burger Menu -->
                <button id="menu-toggle"
                        class="flex flex-col w-8 h-8 justify-center items-center space-y-1.5 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg p-1 transition-colors"
                        onclick="toggleMenu()">
                    <div class="burger-line w-6 h-0.5 bg-gray-600 dark:bg-gray-300 rounded-full"></div>
                    <div class="burger-line w-6 h-0.5 bg-gray-600 dark:bg-gray-300 rounded-full"></div>
                    <div class="burger-line w-6 h-0.5 bg-gray-600 dark:bg-gray-300 rounded-full"></div>
                </button>

                <!-- Center: Logo & Title -->
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-primary rounded-xl flex items-center justify-center">
                        <span class="material-symbols-outlined text-white text-sm">local_shipping</span>
                    </div>
                    <h1 class="text-lg font-bold hidden sm:block">Delivery Charges</h1>
                </div>

                <!-- Right: Actions -->
                <div class="flex items-center gap-2">
                    <!-- Theme Toggle -->
                    <button onclick="toggleDarkMode()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl transition-colors">
                        <span class="material-symbols-outlined text-gray-600 dark:text-gray-300" id="theme-toggle">dark_mode</span>
                    </button>

                    <!-- Refresh -->
                    <button onclick="refreshData()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl transition-colors">
                        <span class="material-symbols-outlined text-gray-600 dark:text-gray-300">refresh</span>
                    </button>

                    <!-- Profile -->
                    <div class="w-8 h-8 bg-gradient-to-br from-primary to-primary rounded-xl flex items-center justify-center">
                        <span class="material-symbols-outlined text-white text-sm">person</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Burger Menu Sidebar -->
        <div id="menu-overlay" class="fixed inset-0 bg-black/50 menu-overlay z-40 hidden" onclick="closeMenu()"></div>
        <div id="menu-sidebar" class="fixed top-0 right-0 h-full w-80 max-w-[85vw] bg-white dark:bg-background-dark border-l border-border-light dark:border-border-dark z-50 transform translate-x-full transition-transform duration-300">
            <!-- Menu Header -->
            <div class="p-6 border-b border-border-light dark:border-border-dark">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">Menu</h2>
                    <button onclick="closeMenu()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl transition-colors">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <div class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-xl">
                    <div class="w-10 h-10 bg-gradient-to-br from-primary to-primary rounded-xl flex items-center justify-center">
                        <span class="material-symbols-outlined text-white">person</span>
                    </div>
                    <div>
                        <p class="font-semibold">Admin User</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">admin@store.com</p>
                    </div>
                </div>
            </div>

            <!-- Menu Items -->
            <nav class="p-6 space-y-2">
    <a href="{{ url_for('dashboard') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
        <span class="material-symbols-rounded">dashboard</span>
        <span>Dashboard</span>
    </a>
    <a href="{{ url_for('orders') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
        <span class="material-symbols-rounded">receipt_long</span>
        <span>Orders</span>
        <span class="ml-auto bg-red-500 text-white text-xs px-2 py-1 rounded-full">{{ data.active_orders if data is defined else '0' }}</span>
    </a>
    <a href="{{ url_for('create_order') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
        <span class="material-symbols-rounded">add_circle</span>
        <span>Create Order</span>
    </a>
    <a href="{{ url_for('customers') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
        <span class="material-symbols-rounded">group</span>
        <span>Customers</span>
    </a>
    <a href="{{ url_for('items') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
        <span class="material-symbols-rounded">inventory</span>
        <span>Item Master</span>
    </a>
    <a href="{{ url_for('drivers') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
        <span class="material-symbols-rounded">drive_eta</span>
        <span>Drivers</span>
    </a>
    <a href="{{ url_for('expenses') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
        <span class="material-symbols-rounded">receipt</span>
        <span>Expenses</span>
    </a>
    <!-- THIS SHOULD BE ACTIVE FOR DELIVERY CHARGES PAGE -->
    <a href="{{ url_for('delivery_charges') }}" class="flex items-center gap-4 p-4 rounded-xl bg-primary/10 text-primary font-medium">
        <span class="material-symbols-rounded">local_shipping</span>
        <span>Delivery Charges</span>
    </a>
    <a href="{{ url_for('balance_due') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
        <span class="material-symbols-rounded">account_balance_wallet</span>
        <span>Balance Due</span>
    </a>
   

                <div class="border-t border-border dark:border-border-dark my-4"></div>

                <a href="{{ url_for('settings') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                    <span class="material-symbols-rounded">settings</span>
                    <span>Settings</span>
                </a>
                <a href="{{ url_for('help_support') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                    <span class="material-symbols-rounded">help</span>
                    <span>Help & Support</span>
                </a>
                <a href="{{ url_for('logout') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 dark:text-red-400 transition-colors">
                    <span class="material-symbols-rounded">logout</span>
                    <span>Logout</span>
                </a>
            </nav>
        </div>

        <main class="flex-1 overflow-y-auto">
            <div class="p-4 space-y-6">
                <!-- Summary Stats -->
                <section>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="stats-card bg-white dark:bg-background-dark border border-border-light dark:border-border-dark p-4 rounded-xl shadow-sm">
                            <div class="flex items-center gap-3">
                                <div class="bg-red-100 dark:bg-red-900/30 p-3 rounded-full">
                                    <span class="material-symbols-outlined text-red-600 dark:text-red-400">pending</span>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-content-light dark:text-content-dark" id="total-pending">₹72,540</p>
                                    <p class="text-sm text-subtle-light dark:text-subtle-dark">Total Pending</p>
                                </div>
                            </div>
                        </div>

                        <div class="stats-card bg-white dark:bg-background-dark border border-border-light dark:border-border-dark p-4 rounded-xl shadow-sm">
                            <div class="flex items-center gap-3">
                                <div class="bg-green-100 dark:bg-green-900/30 p-3 rounded-full">
                                    <span class="material-symbols-outlined text-green-600 dark:text-green-400">payments</span>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-content-light dark:text-content-dark" id="total-paid">₹27,540</p>
                                    <p class="text-sm text-subtle-light dark:text-subtle-dark">Total Paid</p>
                                </div>
                            </div>
                        </div>

                        <div class="stats-card bg-white dark:bg-background-dark border border-border-light dark:border-border-dark p-4 rounded-xl shadow-sm">
                            <div class="flex items-center gap-3">
                                <div class="bg-blue-100 dark:bg-blue-900/30 p-3 rounded-full">
                                    <span class="material-symbols-outlined text-blue-600 dark:text-blue-400">local_shipping</span>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-content-light dark:text-content-dark" id="active-deliveries">5</p>
                                    <p class="text-sm text-subtle-light dark:text-subtle-dark">Active Loads</p>
                                </div>
                            </div>
                        </div>

                        <div class="stats-card bg-white dark:bg-background-dark border border-border-light dark:border-border-dark p-4 rounded-xl shadow-sm">
                            <div class="flex items-center gap-3">
                                <div class="bg-purple-100 dark:bg-purple-900/30 p-3 rounded-full">
                                    <span class="material-symbols-outlined text-purple-600 dark:text-purple-400">account_balance_wallet</span>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-content-light dark:text-content-dark" id="this-month">₹1,00,080</p>
                                    <p class="text-sm text-subtle-light dark:text-subtle-dark">This Month</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Quick Actions -->
                <section>
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-content-light dark:text-content-dark">Quick Actions</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="showAddDeliveryModal()" class="delivery-card flex items-center gap-4 bg-primary text-white p-4 rounded-xl hover:bg-primary/90 transition-all">
                            <span class="material-symbols-outlined text-2xl">add_circle</span>
                            <div class="text-left">
                                <p class="font-semibold text-lg">Add New Delivery</p>
                                <p class="text-sm text-white/80">Create new delivery record</p>
                            </div>
                        </button>
                        <button onclick="showPaymentModal()" class="delivery-card flex items-center gap-4 bg-white dark:bg-background-dark border border-border-light dark:border-border-dark p-4 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 transition-all">
                            <span class="material-symbols-outlined text-2xl text-green-600">payments</span>
                            <div class="text-left">
                                <p class="font-semibold text-lg text-content-light dark:text-content-dark">Record Payment</p>
                                <p class="text-sm text-subtle-light dark:text-subtle-dark">Add payment for existing delivery</p>
                            </div>
                        </button>
                    </div>
                </section>

                <!-- Pending Deliveries -->
                <section>
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-content-light dark:text-content-dark">Pending Deliveries</h2>
                        <div class="flex gap-2">
                            <select class="px-3 py-1.5 text-sm bg-white dark:bg-background-dark border border-border-light dark:border-border-dark rounded-lg" onchange="filterDeliveries(this.value)">
                                <option value="">All Vehicles</option>
                                <option value="3830">3830</option>
                                <option value="AP16TU1652">AP16TU1652</option>
                                <option value="AP20TC0477">AP20TC0477</option>
                            </select>
                        </div>
                    </div>
                    <div class="space-y-3" id="pending-deliveries">
                        <!-- Pending deliveries will be populated here -->
                    </div>
                </section>

                <!-- Payment History -->
                <section>
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-content-light dark:text-content-dark">Recent Payments</h2>
                        <button class="text-primary text-sm hover:underline" onclick="viewAllPayments()">View All</button>
                    </div>
                    <div class="bg-white dark:bg-background-dark border border-border-light dark:border-border-dark rounded-xl overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50 dark:bg-gray-800">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-subtle-light dark:text-subtle-dark uppercase tracking-wider">Payment Date</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-subtle-light dark:text-subtle-dark uppercase tracking-wider">Amount Paid</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-subtle-light dark:text-subtle-dark uppercase tracking-wider">Description</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-subtle-light dark:text-subtle-dark uppercase tracking-wider">Paid By</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-subtle-light dark:text-subtle-dark uppercase tracking-wider">Paid To</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-border-light dark:divide-border-dark" id="payment-history">
                                    <!-- Payment history will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Add New Delivery Modal -->
    <div id="add-delivery-modal" class="fixed inset-0 bg-black/50 z-50 hidden" onclick="closeModal('add-delivery-modal')">
        <div class="absolute inset-x-4 top-1/2 transform -translate-y-1/2 max-w-md mx-auto bg-white dark:bg-background-dark rounded-xl shadow-xl" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-content-light dark:text-content-dark">Add New Delivery</h3>
                    <button onclick="closeModal('add-delivery-modal')" class="text-subtle-light dark:text-subtle-dark hover:text-content-light dark:hover:text-content-dark">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <form onsubmit="addNewDelivery(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-content-light dark:text-content-dark mb-1">Date of Load</label>
                        <input type="date" name="loadDate" required class="w-full px-3 py-2 border border-border-light dark:border-border-dark rounded-lg bg-white dark:bg-background-dark">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-content-light dark:text-content-dark mb-1">Vehicle Number</label>
                        <input type="text" name="vehicleNumber" placeholder="e.g., AP16TU1652" required class="w-full px-3 py-2 border border-border-light dark:border-border-dark rounded-lg bg-white dark:bg-background-dark">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-content-light dark:text-content-dark mb-1">Total Amount (₹)</label>
                        <input type="number" name="totalAmount" step="0.01" placeholder="0.00" required class="w-full px-3 py-2 border border-border-light dark:border-border-dark rounded-lg bg-white dark:bg-background-dark">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-content-light dark:text-content-dark mb-1">Description</label>
                        <textarea name="description" rows="2" placeholder="Optional delivery details..." class="w-full px-3 py-2 border border-border-light dark:border-border-dark rounded-lg bg-white dark:bg-background-dark"></textarea>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeModal('add-delivery-modal')" class="flex-1 px-4 py-2 border border-border-light dark:border-border-dark rounded-lg text-content-light dark:text-content-dark hover:bg-gray-50 dark:hover:bg-gray-800">
                            Cancel
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                            Add Delivery
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="fixed inset-0 bg-black/50 z-50 hidden" onclick="closeModal('payment-modal')">
        <div class="absolute inset-x-4 top-1/2 transform -translate-y-1/2 max-w-md mx-auto bg-white dark:bg-background-dark rounded-xl shadow-xl" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-content-light dark:text-content-dark">Record Payment</h3>
                    <button onclick="closeModal('payment-modal')" class="text-subtle-light dark:text-subtle-dark hover:text-content-light dark:hover:text-content-dark">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <form onsubmit="recordPayment(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-content-light dark:text-content-dark mb-1">Select Delivery</label>
                        <select name="deliveryId" required class="w-full px-3 py-2 border border-border-light dark:border-border-dark rounded-lg bg-white dark:bg-background-dark" id="delivery-select">
                            <option value="">Choose pending delivery...</option>
                        </select>
                    </div>
                    <div id="delivery-details" class="hidden bg-gray-50 dark:bg-gray-800 p-3 rounded-lg">
                        <p class="text-sm"><span class="font-medium">Vehicle:</span> <span id="selected-vehicle"></span></p>
                        <p class="text-sm"><span class="font-medium">Total Amount:</span> ₹<span id="selected-total"></span></p>
                        <p class="text-sm"><span class="font-medium">Amount Due:</span> ₹<span id="selected-due"></span></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-content-light dark:text-content-dark mb-1">Payment Date</label>
                        <input type="date" name="paymentDate" required class="w-full px-3 py-2 border border-border-light dark:border-border-dark rounded-lg bg-white dark:bg-background-dark">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-content-light dark:text-content-dark mb-1">Amount Paid (₹)</label>
                        <input type="number" name="amountPaid" step="0.01" placeholder="0.00" required class="w-full px-3 py-2 border border-border-light dark:border-border-dark rounded-lg bg-white dark:bg-background-dark" oninput="validatePaymentAmount(this)">
                        <p class="text-xs text-subtle-light dark:text-subtle-dark mt-1">Enter partial or full payment amount</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-content-light dark:text-content-dark mb-1">Paid By (Manager)</label>
                        <select name="paidBy" required class="w-full px-3 py-2 border border-border-light dark:border-border-dark rounded-lg bg-white dark:bg-background-dark">
                            <option value="">Select Manager</option>
                            <option value="Manager1">Manager1</option>
                            <option value="Manager2">Manager2</option>
                            <option value="Manager3">Manager3</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-content-light dark:text-content-dark mb-1">Paid To</label>
                        <input type="text" name="paidTo" placeholder="e.g., Driver, Mathew, etc." required class="w-full px-3 py-2 border border-border-light dark:border-border-dark rounded-lg bg-white dark:bg-background-dark text-content-light dark:text-content-dark placeholder:text-subtle-light dark:placeholder:text-subtle-dark">
                        <p class="text-xs text-subtle-light dark:text-subtle-dark mt-1">Enter recipient name (Driver, Contractor, etc.)</p>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeModal('payment-modal')" class="flex-1 px-4 py-2 border border-border-light dark:border-border-dark rounded-lg text-content-light dark:text-content-dark hover:bg-gray-50 dark:hover:bg-gray-800">
                            Cancel
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            Record Payment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Sample data
        let deliveryData = [
            {
                id: 1,
                loadDate: '18-3-25',
                vehicleNumber: '3830',
                totalAmount: 11440.00,
                description: '',
                amountDue: 11440.00,
                payments: []
            },
            {
                id: 2,
                loadDate: '22-3-25',
                vehicleNumber: 'AP16TU1652',
                totalAmount: 16100.00,
                description: '',
                amountDue: 16100.00,
                payments: []
            },
            {
                id: 3,
                loadDate: '22-3-25',
                vehicleNumber: 'AP20TC0477',
                totalAmount: 12500.00,
                description: '',
                amountDue: 12500.00,
                payments: []
            },
            {
                id: 4,
                loadDate: '22-3-25',
                vehicleNumber: 'AP26TT1969',
                totalAmount: 13000.00,
                description: '',
                amountDue: 13000.00,
                payments: []
            },
            {
                id: 5,
                loadDate: '24/3/25',
                vehicleNumber: 'TS02UB3830',
                totalAmount: 15500.00,
                description: '',
                amountDue: 15500.00,
                payments: []
            }
        ];

        let paymentHistory = [
            {
                paymentDate: '18-3-25',
                amountPaid: 7200.00,
                description: 'KANTAS AND KIRAYI PAID',
                paidBy: 'Manager1',
                paidTo: 'Driver'
            },
            {
                paymentDate: '19-3-25',
                amountPaid: 4240.00,
                description: 'KANTAS AND KIRAYI PAID',
                paidBy: 'Manager2',
                paidTo: 'Mathew'
            },
            {
                paymentDate: '20-3-25',
                amountPaid: 11500.00,
                description: 'KANTAS AND KIRAYI PAID',
                paidBy: 'Manager1',
                paidTo: 'DRIVER'
            },
            {
                paymentDate: '20-3-25',
                amountPaid: 4600.00,
                description: 'KANTAS AND KIRAYI PAID',
                paidBy: 'Manager1',
                paidTo: 'DRIVER'
            }
        ];

        // Menu Functions
        function toggleMenu() {
            const menuToggle = document.getElementById('menu-toggle');
            const menuOverlay = document.getElementById('menu-overlay');
            const menuSidebar = document.getElementById('menu-sidebar');

            menuToggle.classList.toggle('burger-active');
            menuOverlay.classList.toggle('hidden');

            if (menuSidebar.style.transform === 'translateX(0px)') {
                menuSidebar.style.transform = 'translateX(100%)';
            } else {
                menuSidebar.style.transform = 'translateX(0px)';
            }
        }

        function closeMenu() {
            const menuToggle = document.getElementById('menu-toggle');
            const menuOverlay = document.getElementById('menu-overlay');
            const menuSidebar = document.getElementById('menu-sidebar');

            menuToggle.classList.remove('burger-active');
            menuOverlay.classList.add('hidden');
            menuSidebar.style.transform = 'translateX(100%)';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            loadPendingDeliveries();
            loadPaymentHistory();
            updateStats();

            // Set today's date as default in forms
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value) input.value = today;
            });

            // Check for saved dark mode preference
            if (localStorage.getItem('darkMode') === 'true') {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-toggle').textContent = 'light_mode';
            }

            // Close menu on window resize
            window.addEventListener('resize', () => {
                if (window.innerWidth > 768) {
                    closeMenu();
                }
            });
        });

        function loadPendingDeliveries() {
            const container = document.getElementById('pending-deliveries');
            container.innerHTML = '';

            const pendingDeliveries = deliveryData.filter(delivery => delivery.amountDue > 0);

            if (pendingDeliveries.length === 0) {
                container.innerHTML = `
                        <div class="text-center py-8 text-subtle-light dark:text-subtle-dark">
                            <span class="material-symbols-outlined text-6xl mb-4 block">local_shipping</span>
                            <p>No pending deliveries</p>
                            <p class="text-sm">All deliveries are fully paid</p>
                        </div>
                    `;
                return;
            }

            pendingDeliveries.forEach(delivery => {
                const progressPercentage = ((delivery.totalAmount - delivery.amountDue) / delivery.totalAmount) * 100;

                const deliveryCard = document.createElement('div');
                deliveryCard.className = 'delivery-card bg-white dark:bg-background-dark border border-border-light dark:border-border-dark rounded-xl p-4 shadow-sm';
                deliveryCard.innerHTML = `
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="pending-indicator w-3 h-3 bg-red-500 rounded-full"></div>
                                <div>
                                    <p class="font-semibold text-content-light dark:text-content-dark">${delivery.vehicleNumber}</p>
                                    <p class="text-sm text-subtle-light dark:text-subtle-dark">Load Date: ${delivery.loadDate}</p>
                                </div>
                            </div>
                            <span class="px-2 py-1 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 text-xs font-medium rounded-full">
                                Pending
                            </span>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-3">
                            <div>
                                <p class="text-xs text-subtle-light dark:text-subtle-dark uppercase tracking-wider">Total Amount</p>
                                <p class="text-lg font-bold text-content-light dark:text-content-dark">₹${delivery.totalAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}</p>
                            </div>
                            <div>
                                <p class="text-xs text-subtle-light dark:text-subtle-dark uppercase tracking-wider">Amount Due</p>
                                <p class="text-lg font-bold text-red-600 dark:text-red-400">₹${delivery.amountDue.toLocaleString('en-IN', { minimumFractionDigits: 2 })}</p>
                            </div>
                        </div>

                        ${progressPercentage > 0 ? `
                        <div class="mb-3">
                            <div class="flex justify-between text-xs text-subtle-light dark:text-subtle-dark mb-1">
                                <span>Payment Progress</span>
                                <span>${progressPercentage.toFixed(1)}%</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width: ${progressPercentage}%"></div>
                            </div>
                        </div>
                        ` : ''}

                        <div class="flex gap-2">
                            <button onclick="showPaymentModalForDelivery(${delivery.id})" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                <span class="material-symbols-outlined text-sm mr-1">payments</span>
                                Record Payment
                            </button>
                            <button onclick="viewDeliveryDetails(${delivery.id})" class="px-4 py-2 border border-border-light dark:border-border-dark rounded-lg text-content-light dark:text-content-dark hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                                <span class="material-symbols-outlined text-sm">visibility</span>
                            </button>
                        </div>
                    `;
                container.appendChild(deliveryCard);
            });

            // Update delivery select dropdown
            updateDeliverySelect();
        }

        function loadPaymentHistory() {
            const tbody = document.getElementById('payment-history');
            tbody.innerHTML = '';

            paymentHistory.slice(0, 10).forEach(payment => {
                const row = document.createElement('tr');
                row.className = 'payment-row';
                row.innerHTML = `
                        <td class="px-4 py-3 text-sm text-content-light dark:text-content-dark">${payment.paymentDate}</td>
                        <td class="px-4 py-3 text-sm font-medium text-green-600 dark:text-green-400">₹${payment.amountPaid.toLocaleString('en-IN', { minimumFractionDigits: 2 })}</td>
                        <td class="px-4 py-3 text-sm text-content-light dark:text-content-dark">${payment.description}</td>
                        <td class="px-4 py-3 text-sm text-content-light dark:text-content-dark">${payment.paidBy}</td>
                        <td class="px-4 py-3 text-sm text-content-light dark:text-content-dark">${payment.paidTo}</td>
                    `;
                tbody.appendChild(row);
            });
        }

        function updateStats() {
            const totalPending = deliveryData.reduce((sum, delivery) => sum + delivery.amountDue, 0);
            const totalPaid = paymentHistory.reduce((sum, payment) => sum + payment.amountPaid, 0);
            const activeDeliveries = deliveryData.filter(delivery => delivery.amountDue > 0).length;
            const thisMonth = totalPending + totalPaid;

            document.getElementById('total-pending').textContent = `₹${totalPending.toLocaleString('en-IN')}`;
            document.getElementById('total-paid').textContent = `₹${totalPaid.toLocaleString('en-IN')}`;
            document.getElementById('active-deliveries').textContent = activeDeliveries;
            document.getElementById('this-month').textContent = `₹${thisMonth.toLocaleString('en-IN')}`;
        }

        function updateDeliverySelect() {
            const select = document.getElementById('delivery-select');
            select.innerHTML = '<option value="">Choose pending delivery...</option>';

            deliveryData.filter(delivery => delivery.amountDue > 0).forEach(delivery => {
                const option = document.createElement('option');
                option.value = delivery.id;
                option.textContent = `${delivery.vehicleNumber} - ${delivery.loadDate} (₹${delivery.amountDue.toLocaleString('en-IN')})`;
                select.appendChild(option);
            });

            select.addEventListener('change', function () {
                const deliveryId = parseInt(this.value);
                const delivery = deliveryData.find(d => d.id === deliveryId);

                if (delivery) {
                    document.getElementById('selected-vehicle').textContent = delivery.vehicleNumber;
                    document.getElementById('selected-total').textContent = delivery.totalAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 });
                    document.getElementById('selected-due').textContent = delivery.amountDue.toLocaleString('en-IN', { minimumFractionDigits: 2 });
                    document.getElementById('delivery-details').classList.remove('hidden');
                } else {
                    document.getElementById('delivery-details').classList.add('hidden');
                }
            });
        }

        function showAddDeliveryModal() {
            document.getElementById('add-delivery-modal').classList.remove('hidden');
        }

        function showPaymentModal() {
            updateDeliverySelect();
            document.getElementById('payment-modal').classList.remove('hidden');
        }

        function showPaymentModalForDelivery(deliveryId) {
            showPaymentModal();
            setTimeout(() => {
                document.getElementById('delivery-select').value = deliveryId;
                document.getElementById('delivery-select').dispatchEvent(new Event('change'));
            }, 100);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function addNewDelivery(event) {
            event.preventDefault();
            const formData = new FormData(event.target);

            const newDelivery = {
                id: Date.now(),
                loadDate: formData.get('loadDate'),
                vehicleNumber: formData.get('vehicleNumber').toUpperCase(),
                totalAmount: parseFloat(formData.get('totalAmount')),
                description: formData.get('description') || '',
                amountDue: parseFloat(formData.get('totalAmount')),
                payments: []
            };

            deliveryData.push(newDelivery);
            loadPendingDeliveries();
            updateStats();
            closeModal('add-delivery-modal');
            event.target.reset();

            showSuccessMessage(`New delivery added for vehicle ${newDelivery.vehicleNumber}`);
        }

        function recordPayment(event) {
            event.preventDefault();
            const formData = new FormData(event.target);

            const deliveryId = parseInt(formData.get('deliveryId'));
            const amountPaid = parseFloat(formData.get('amountPaid'));

            const delivery = deliveryData.find(d => d.id === deliveryId);
            if (!delivery) {
                alert('Please select a valid delivery');
                return;
            }

            if (amountPaid > delivery.amountDue) {
                alert(`Payment amount cannot exceed the due amount of ₹${delivery.amountDue.toLocaleString('en-IN')}`);
                return;
            }

            // Update delivery
            delivery.amountDue -= amountPaid;
            delivery.payments.push({
                date: formData.get('paymentDate'),
                amount: amountPaid,
                paidBy: formData.get('paidBy'),
                paidTo: formData.get('paidTo')
            });

            // Add to payment history
            const newPayment = {
                paymentDate: formData.get('paymentDate'),
                amountPaid: amountPaid,
                description: 'KANTAS AND KIRAYI PAID',
                paidBy: formData.get('paidBy'),
                paidTo: formData.get('paidTo')
            };
            paymentHistory.unshift(newPayment);

            loadPendingDeliveries();
            loadPaymentHistory();
            updateStats();
            closeModal('payment-modal');
            event.target.reset();

            const isFullyPaid = delivery.amountDue === 0;
            showSuccessMessage(
                `Payment of ₹${amountPaid.toLocaleString('en-IN')} recorded successfully. ${isFullyPaid ? 'Delivery is now fully paid!' : `Remaining due: ₹${delivery.amountDue.toLocaleString('en-IN')}`
                }`
            );
        }

        function validatePaymentAmount(input) {
            const deliveryId = parseInt(document.getElementById('delivery-select').value);
            const delivery = deliveryData.find(d => d.id === deliveryId);

            if (delivery && parseFloat(input.value) > delivery.amountDue) {
                input.setCustomValidity(`Amount cannot exceed ₹${delivery.amountDue.toLocaleString('en-IN')}`);
            } else {
                input.setCustomValidity('');
            }
        }

        function filterDeliveries(vehicleFilter) {
            const deliveryCards = document.querySelectorAll('#pending-deliveries .delivery-card');

            deliveryCards.forEach(card => {
                const vehicleText = card.querySelector('p.font-semibold').textContent;
                if (!vehicleFilter || vehicleText.includes(vehicleFilter)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function viewDeliveryDetails(deliveryId) {
            const delivery = deliveryData.find(d => d.id === deliveryId);
            if (delivery) {
                const paymentsList = delivery.payments.length > 0
                    ? delivery.payments.map(p => `• ${p.date}: ₹${p.amount.toLocaleString('en-IN')} (${p.paidBy} → ${p.paidTo})`).join('\n')
                    : 'No payments recorded yet';

                alert(`Delivery Details:\n\nVehicle: ${delivery.vehicleNumber}\nLoad Date: ${delivery.loadDate}\nTotal Amount: ₹${delivery.totalAmount.toLocaleString('en-IN')}\nAmount Due: ₹${delivery.amountDue.toLocaleString('en-IN')}\n\nPayments:\n${paymentsList}`);
            }
        }

        function viewAllPayments() {
            alert('Opening full payment history...');
        }

        function showSuccessMessage(message) {
            // Create a temporary success message
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-20 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            successDiv.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined">check_circle</span>
                        <span>${message}</span>
                    </div>
                `;
            document.body.appendChild(successDiv);

            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        function refreshData() {
            loadPendingDeliveries();
            loadPaymentHistory();
            updateStats();
            showSuccessMessage('Data refreshed successfully');
        }

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            const toggle = document.getElementById('theme-toggle');
            toggle.textContent = document.documentElement.classList.contains('dark') ? 'light_mode' : 'dark_mode';
            localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
        }

        function goBack() {
            window.location.href = 'dashboard.html';
        }
    </script>
</body>
</html>