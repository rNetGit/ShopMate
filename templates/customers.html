{% extends "base.html" %}

{% block title %}Customer Management - Store Management{% endblock %}

{% block extra_head %}
<style>
    /* Burger menu animations */
    .burger-line {
        transition: all 0.3s ease;
        transform-origin: center;
    }

    .burger-active .burger-line:nth-child(1) {
        transform: rotate(45deg) translate(6px, 6px);
    }

    .burger-active .burger-line:nth-child(2) {
        opacity: 0;
    }

    .burger-active .burger-line:nth-child(3) {
        transform: rotate(-45deg) translate(6px, -6px);
    }

    /* Mobile menu overlay */
    .menu-overlay {
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
    }

    body {
        min-height: max(884px, 100dvh);
    }

    .customer-card {
        transition: all 0.2s ease-in-out;
    }

        .customer-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(17, 115, 212, 0.1);
        }
</style>
{% endblock %}

{% block content %}
<div class="flex h-screen flex-col overflow-hidden">
    <!-- Enhanced Mobile-First Header -->
    <header class="flex-shrink-0 bg-white/95 dark:bg-surface-dark/95 backdrop-blur-sm border-b border-border dark:border-border-dark sticky top-0 z-50">
        <div class="flex h-16 items-center justify-between px-4 sm:px-6">
            <!-- Left: Burger Menu -->
            <button id="menu-toggle"
                    class="flex flex-col w-8 h-8 justify-center items-center space-y-1.5 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg p-1 transition-colors"
                    onclick="toggleMenu()">
                <div class="burger-line w-6 h-0.5 bg-gray-600 dark:bg-gray-300 rounded-full"></div>
                <div class="burger-line w-6 h-0.5 bg-gray-600 dark:bg-gray-300 rounded-full"></div>
                <div class="burger-line w-6 h-0.5 bg-gray-600 dark:bg-gray-300 rounded-full"></div>
            </button>

            <!-- Center: Logo & Title -->
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-primary rounded-xl flex items-center justify-center">
                    <span class="material-symbols-rounded text-white text-lg">group</span>
                </div>
                <h1 class="text-lg font-bold hidden sm:block">Customer Management</h1>
            </div>

            <!-- Right: Actions -->
            <div class="flex items-center gap-2">
                <!-- Add Customer -->
                <button class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl transition-colors"
                        onclick="showAddCustomerModal()" title="Add New Customer">
                    <span class="material-symbols-rounded text-gray-600 dark:text-gray-300">person_add</span>
                </button>

                <!-- Profile -->
                <div class="w-8 h-8 bg-gradient-to-br from-primary to-primary-light rounded-xl flex items-center justify-center">
                    <span class="material-symbols-rounded text-white text-sm">person</span>
                </div>
            </div>
        </div>

        <!-- Search and Filter Bar -->
        <div class="p-4 space-y-3">
            <div class="relative">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                    <span class="material-symbols-rounded text-gray-500 dark:text-gray-400">search</span>
                </div>
                <input id="search-input" class="w-full pl-10 pr-4 py-2 rounded-lg bg-white dark:bg-surface-dark border border-border dark:border-border-dark text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-primary"
                       placeholder="Search customers by name, phone, or address..."
                       type="search"
                       oninput="filterCustomers()" />
            </div>

            <!-- Filter Tabs -->
            <div class="flex gap-2 overflow-x-auto">
                <button onclick="filterByStatus('all')" class="customer-filter active whitespace-nowrap px-4 py-2 rounded-full text-sm font-medium bg-primary text-white">
                    All Customers
                </button>
                <button onclick="filterByStatus('active')" class="customer-filter whitespace-nowrap px-4 py-2 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 hover:bg-primary/10">
                    Active
                </button>
                <button onclick="filterByStatus('new')" class="customer-filter whitespace-nowrap px-4 py-2 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 hover:bg-primary/10">
                    New
                </button>
                <button onclick="filterByStatus('vip')" class="customer-filter whitespace-nowrap px-4 py-2 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 hover:bg-primary/10">
                    VIP
                </button>
            </div>
        </div>
    </header>

    <!-- Burger Menu Sidebar -->
    <div id="menu-overlay" class="fixed inset-0 bg-black/50 menu-overlay z-40 hidden" onclick="closeMenu()"></div>
    <div id="menu-sidebar" class="fixed top-0 right-0 h-full w-80 max-w-[85vw] bg-white dark:bg-surface-dark border-l border-border dark:border-border-dark z-50 transform translate-x-full transition-transform duration-300">
        <!-- Menu Header -->
        <div class="p-6 border-b border-border dark:border-border-dark">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">Menu</h2>
                <button onclick="closeMenu()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl transition-colors">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <div class="flex items-center gap-3 p-3 bg-surface dark:bg-background-dark rounded-xl">
                <div class="w-10 h-10 bg-gradient-to-br from-primary to-primary-light rounded-xl flex items-center justify-center">
                    <span class="material-symbols-rounded text-white">person</span>
                </div>
                <div>
                    <p class="font-semibold">Admin User</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">admin@store.com</p>
                </div>
            </div>
        </div>

        <!-- Menu Items -->
        <nav class="p-6 space-y-2">
            <a href="{{ url_for('dashboard') }}" class="flex items-center gap-4 p-4 rounded-xl bg-primary/10 text-primary font-medium">
                <span class="material-symbols-rounded">dashboard</span>
                <span>Dashboard</span>
            </a>
            <a href="{{ url_for('orders') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-rounded">receipt_long</span>
                <span>Orders</span>
                <span class="ml-auto bg-red-500 text-white text-xs px-2 py-1 rounded-full">{{ data.active_orders }}</span>
            </a>
            <a href="{{ url_for('create_order') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-rounded">add_circle</span>
                <span>Create Order</span>
            </a>
            <a href="{{ url_for('customers') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-rounded">group</span>
                <span>Customers</span>
            </a>
            <a href="{{ url_for('items') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-rounded">inventory</span>
                <span>Item Master</span>
            </a>
            <!-- ADD THESE TWO MISSING MENU ITEMS -->
            <a href="{{ url_for('drivers') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-rounded">drive_eta</span>
                <span>Drivers</span>
            </a>
            <a href="{{ url_for('expenses') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-rounded">receipt</span>
                <span>Expenses</span>
            </a>
            <!-- END OF ADDED ITEMS -->
            <a href="{{ url_for('delivery_charges') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-rounded">local_shipping</span>
                <span>Delivery Charges</span>
            </a>
            <a href="{{ url_for('balance_due') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-rounded">account_balance_wallet</span>
                <span>Balance Due</span>
            </a>
            <a href="{{ url_for('reminders') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-rounded">schedule</span>
                <span>Reminders</span>
            </a>
            <div class="border-t border-border dark:border-border-dark my-4"></div>

            <a href="{{ url_for('settings') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-rounded">settings</span>
                <span>Settings</span>
            </a>
            <a href="{{ url_for('help_support') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-rounded">help</span>
                <span>Help & Support</span>
            </a>
            <a href="{{ url_for('logout') }}" class="flex items-center gap-4 p-4 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 dark:text-red-400 transition-colors">
                <span class="material-symbols-rounded">logout</span>
                <span>Logout</span>
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-4">
        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white dark:bg-surface-dark border border-border dark:border-border-dark rounded-lg p-4">
                <div class="flex items-center gap-3">
                    <div class="bg-primary/10 p-2 rounded-full">
                        <span class="material-symbols-rounded text-primary">group</span>
                    </div>
                    <div>
                        <p class="text-2xl font-bold" id="total-customers">{{ customers|length }}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Total Customers</p>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-surface-dark border border-border dark:border-border-dark rounded-lg p-4">
                <div class="flex items-center gap-3">
                    <div class="bg-green-100 dark:bg-green-900/30 p-2 rounded-full">
                        <span class="material-symbols-rounded text-green-600 dark:text-green-400">person_add</span>
                    </div>
                    <div>
                        <p class="text-2xl font-bold" id="new-customers">12</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">New This Month</p>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-surface-dark border border-border dark:border-border-dark rounded-lg p-4">
                <div class="flex items-center gap-3">
                    <div class="bg-yellow-100 dark:bg-yellow-900/30 p-2 rounded-full">
                        <span class="material-symbols-rounded text-yellow-600 dark:text-yellow-400">star</span>
                    </div>
                    <div>
                        <p class="text-2xl font-bold" id="vip-customers">23</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">VIP Customers</p>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-surface-dark border border-border dark:border-border-dark rounded-lg p-4">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-100 dark:bg-blue-900/30 p-2 rounded-full">
                        <span class="material-symbols-rounded text-blue-600 dark:text-blue-400">shopping_bag</span>
                    </div>
                    <div>
                        <p class="text-2xl font-bold" id="active-orders">48</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Active Orders</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Customers List -->
        <div id="customers-list" class="space-y-4">
            {% for customer in customers %}
            <div class="customer-card bg-white dark:bg-surface-dark border border-border dark:border-border-dark rounded-lg p-4" data-status="active" data-customer-name="{{ customer.name }}" data-phone="{{ customer.phone }}" data-address="{{ customer.address }}">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
                            {{ customer.name.split(' ') | map('first') | join('') | upper }}
                        </div>
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-semibold">{{ customer.name }}</h3>
                                <span class="px-2 py-0.5 bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 text-xs font-medium rounded-full">Active</span>
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">📞 {{ customer.phone }}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">📍 {{ customer.address }}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">📧 {{ customer.email }}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="createOrderForCustomer('{{ customer.id }}')" class="px-3 py-1.5 bg-primary text-white text-sm rounded-lg hover:bg-primary/90 transition-colors" title="Create Order">
                            <span class="material-symbols-rounded text-sm">add_shopping_cart</span>
                        </button>
                        <button onclick="showCustomerActions('{{ customer.id }}')" class="p-1.5 text-gray-500 dark:text-gray-400 hover:text-primary rounded-lg hover:bg-primary/10 transition-colors" title="More Actions">
                            <span class="material-symbols-rounded text-sm">more_vert</span>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- No Results State -->
        <div id="no-results" class="hidden text-center py-12">
            <span class="material-symbols-rounded text-6xl text-gray-500 dark:text-gray-400 mb-4 block">search_off</span>
            <p class="text-lg font-medium">No customers found</p>
            <p class="text-gray-500 dark:text-gray-400">Try adjusting your search or filter criteria</p>
        </div>
    </main>
</div>

<!-- Add Customer Modal -->
<div id="customer-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white dark:bg-surface-dark w-full max-w-md rounded-2xl shadow-xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between p-6 border-b border-border dark:border-border-dark">
            <h3 id="modal-title" class="text-lg font-bold">Add New Customer</h3>
            <button onclick="closeCustomerModal()" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                <span class="material-symbols-rounded">close</span>
            </button>
        </div>
        <form id="customer-form" class="p-6 space-y-4" onsubmit="saveCustomer(event)">
            <div>
                <label class="block text-sm font-medium mb-2">Full Name</label>
                <input type="text" id="customer-name" required class="w-full p-3 rounded-lg border border-border dark:border-border-dark bg-white dark:bg-surface-dark focus:ring-2 focus:ring-primary" placeholder="Enter full name">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Phone Number</label>
                <input type="tel" id="customer-phone" required class="w-full p-3 rounded-lg border border-border dark:border-border-dark bg-white dark:bg-surface-dark focus:ring-2 focus:ring-primary" placeholder="+1 (555) 123-4567">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Email Address</label>
                <input type="email" id="customer-email" class="w-full p-3 rounded-lg border border-border dark:border-border-dark bg-white dark:bg-surface-dark focus:ring-2 focus:ring-primary" placeholder="customer@example.com">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Address</label>
                <textarea id="customer-address" required rows="3" class="w-full p-3 rounded-lg border border-border dark:border-border-dark bg-white dark:bg-surface-dark focus:ring-2 focus:ring-primary" placeholder="Enter full address"></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Customer Type</label>
                <select id="customer-type" class="w-full p-3 rounded-lg border border-border dark:border-border-dark bg-white dark:bg-surface-dark focus:ring-2 focus:ring-primary">
                    <option value="new">New Customer</option>
                    <option value="active">Active Customer</option>
                    <option value="vip">VIP Customer</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Notes</label>
                <textarea id="customer-notes" rows="2" class="w-full p-3 rounded-lg border border-border dark:border-border-dark bg-white dark:bg-surface-dark focus:ring-2 focus:ring-primary" placeholder="Additional notes or preferences"></textarea>
            </div>
            <div class="flex gap-3 pt-4">
                <button type="button" onclick="closeCustomerModal()" class="flex-1 px-4 py-3 rounded-lg border border-border dark:border-border-dark hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                    Cancel
                </button>
                <button type="submit" class="flex-1 px-4 py-3 rounded-lg bg-primary text-white font-medium hover:bg-primary/90 transition-colors">
                    <span id="save-btn-text">Add Customer</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Customer Actions Modal -->
<div id="customer-actions-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end">
    <div class="bg-white dark:bg-surface-dark w-full rounded-t-2xl p-6 space-y-4">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold">Customer Actions</h3>
            <button onclick="closeCustomerActionsModal()" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                <span class="material-symbols-rounded">close</span>
            </button>
        </div>
        <div class="space-y-2">
            <button onclick="editCustomer()" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-rounded text-blue-600">edit</span>
                <span>Edit Customer</span>
            </button>
            <button onclick="viewOrderHistory()" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-rounded text-green-600">history</span>
                <span>Order History</span>
            </button>
            <button onclick="sendMessage()" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-rounded text-purple-600">message</span>
                <span>Send Message</span>
            </button>
            <button onclick="deleteCustomer()" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                <span class="material-symbols-rounded text-red-600">delete</span>
                <span class="text-red-600">Delete Customer</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Menu Functions
    function toggleMenu() {
        const menuToggle = document.getElementById('menu-toggle');
        const menuOverlay = document.getElementById('menu-overlay');
        const menuSidebar = document.getElementById('menu-sidebar');

        menuToggle.classList.toggle('burger-active');
        menuOverlay.classList.toggle('hidden');

        if (menuSidebar.style.transform === 'translateX(0px)') {
            menuSidebar.style.transform = 'translateX(100%)';
        } else {
            menuSidebar.style.transform = 'translateX(0px)';
        }
    }

    function closeMenu() {
        const menuToggle = document.getElementById('menu-toggle');
        const menuOverlay = document.getElementById('menu-overlay');
        const menuSidebar = document.getElementById('menu-sidebar');

        menuToggle.classList.remove('burger-active');
        menuOverlay.classList.add('hidden');
        menuSidebar.style.transform = 'translateX(100%)';
    }

    let editingCustomer = null;
    let selectedCustomerId = null;

    function goBack() {
        window.history.back();
    }

    // Search and Filter Functions
    function filterCustomers() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        const customerCards = document.querySelectorAll('.customer-card');
        let visibleCustomers = 0;

        customerCards.forEach(card => {
            const name = card.dataset.customerName.toLowerCase();
            const phone = card.dataset.phone.toLowerCase();
            const address = card.dataset.address.toLowerCase();
            const matches = name.includes(searchTerm) || phone.includes(searchTerm) || address.includes(searchTerm);

            if (matches) {
                card.style.display = 'block';
                visibleCustomers++;
            } else {
                card.style.display = 'none';
            }
        });

        // Show/hide no results message
        const noResults = document.getElementById('no-results');
        if (visibleCustomers === 0 && searchTerm) {
            noResults.classList.remove('hidden');
        } else {
            noResults.classList.add('hidden');
        }
    }

    function filterByStatus(status) {
        // Update active filter button
        document.querySelectorAll('.customer-filter').forEach(btn => {
            btn.classList.remove('active', 'bg-primary', 'text-white');
            btn.classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-900', 'dark:text-gray-100');
        });

        event.target.classList.add('active', 'bg-primary', 'text-white');
        event.target.classList.remove('bg-gray-100', 'dark:bg-gray-800', 'text-gray-900', 'dark:text-gray-100');

        const customerCards = document.querySelectorAll('.customer-card');

        customerCards.forEach(card => {
            if (status === 'all' || card.dataset.status === status) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });

        // Clear search when filtering by status
        document.getElementById('search-input').value = '';
        document.getElementById('no-results').classList.add('hidden');
    }

    // Modal Functions
    function showAddCustomerModal() {
        editingCustomer = null;
        document.getElementById('modal-title').textContent = 'Add New Customer';
        document.getElementById('save-btn-text').textContent = 'Add Customer';
        document.getElementById('customer-form').reset();
        document.getElementById('customer-modal').classList.remove('hidden');
    }

    function closeCustomerModal() {
        document.getElementById('customer-modal').classList.add('hidden');
        editingCustomer = null;
    }

    function saveCustomer(event) {
        event.preventDefault();

        const name = document.getElementById('customer-name').value;
        const phone = document.getElementById('customer-phone').value;
        const email = document.getElementById('customer-email').value;
        const address = document.getElementById('customer-address').value;
        const type = document.getElementById('customer-type').value;
        const notes = document.getElementById('customer-notes').value;

        if (editingCustomer) {
            alert('Customer updated successfully!');
        } else {
            // Add new customer to the list
            addCustomerToDOM(name, phone, email, address, type, notes);
            alert('Customer added successfully!');
        }

        closeCustomerModal();
    }

    function addCustomerToDOM(name, phone, email, address, type, notes) {
        const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
        const colors = ['blue', 'purple', 'green', 'pink', 'orange', 'indigo'];
        const color = colors[Math.floor(Math.random() * colors.length)];

        let statusBadge = '';
        switch(type) {
            case 'vip':
                statusBadge = `<span class="px-2 py-0.5 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300 text-xs font-medium rounded-full flex items-center gap-1">
                    <span class="material-symbols-rounded text-xs">star</span>
                    VIP
                </span>`;
                break;
            case 'new':
                statusBadge = `<span class="px-2 py-0.5 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 text-xs font-medium rounded-full">New</span>`;
                break;
            default:
                statusBadge = `<span class="px-2 py-0.5 bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 text-xs font-medium rounded-full">Active</span>`;
        }

        const customerId = name.toLowerCase().replace(/\s+/g, '-');
        const customerHTML = `
            <div class="customer-card bg-white dark:bg-surface-dark border border-border dark:border-border-dark rounded-lg p-4" data-status="${type}" data-customer-name="${name}" data-phone="${phone}" data-address="${address}">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-${color}-500 to-${color}-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
                            ${initials}
                        </div>
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-semibold">${name}</h3>
                                ${statusBadge}
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">📞 ${phone}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">📍 ${address}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">📧 ${email}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="createOrderForCustomer('${customerId}')" class="px-3 py-1.5 bg-primary text-white text-sm rounded-lg hover:bg-primary/90 transition-colors" title="Create Order">
                            <span class="material-symbols-rounded text-sm">add_shopping_cart</span>
                        </button>
                        <button onclick="showCustomerActions('${customerId}')" class="p-1.5 text-gray-500 dark:text-gray-400 hover:text-primary rounded-lg hover:bg-primary/10 transition-colors" title="More Actions">
                            <span class="material-symbols-rounded text-sm">more_vert</span>
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('customers-list').insertAdjacentHTML('afterbegin', customerHTML);
    }

    // Customer Actions
    function createOrderForCustomer(customerId) {
        // Redirect to CreateOrder page with customer pre-selected
        window.location.href = "{{ url_for('create_order') }}?customer=" + customerId;
    }

    function showCustomerActions(customerId) {
        selectedCustomerId = customerId;
        document.getElementById('customer-actions-modal').classList.remove('hidden');
    }

    function closeCustomerActionsModal() {
        document.getElementById('customer-actions-modal').classList.add('hidden');
        selectedCustomerId = null;
    }

    function editCustomer() {
        alert('Edit customer functionality would open here');
        closeCustomerActionsModal();
    }

    function viewOrderHistory() {
        alert(`Opening order history for customer ${selectedCustomerId}`);
        closeCustomerActionsModal();
    }

    function sendMessage() {
        alert(`Opening message interface for customer ${selectedCustomerId}`);
        closeCustomerActionsModal();
    }

    function deleteCustomer() {
        if (confirm('Are you sure you want to delete this customer?')) {
            alert('Customer deleted successfully');
            closeCustomerActionsModal();
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
        // Close menu on window resize
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                closeMenu();
            }
        });

        // Close modals when clicking outside
        document.getElementById('customer-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCustomerModal();
            }
        });

        document.getElementById('customer-actions-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCustomerActionsModal();
            }
        });
    });
</script>
{% endblock %}